name: (Weekly) Package Update Issue

on:
  schedule:
    # JST 07:00 on Monday (UTC 22:00 on Sunday)
    - cron: "0 22 * * SUN"
  workflow_dispatch: {} # Allow manual triggering for testing

jobs:
  create-upgrade-issue:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create package upgrade issue and assign to Copilot
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = [
              '# ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯',
              '',
              '## å®Ÿè¡Œæ‰‹é †',
              '',
              '### 0. ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ',
              '',
              '- ãƒ–ãƒ©ãƒ³ãƒåã¯ `*-yyyymmdd` ã®å½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„',
              '- ä¾‹: `weekly-package-upgrade-20250106`',
              '',
              '### 1. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèª',
              '',
              '```bash',
              'yarn outdated',
              '```',
              '',
              '### 2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥',
              '',
              '- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ãã®ã‚¿ã‚¤ãƒ—ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ@types/*ï¼‰ã‚’ã‚»ãƒƒãƒˆã¨ã—ã¦æ‰±ã†**',
              '- **1ã¤ãšã¤ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã€å„å›ã§å‹•ä½œç¢ºèªã‚’è¡Œã†**',
              '- **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¯æ…é‡ã«è¡Œã„ã€Breaking Changesã‚’ç¢ºèªã™ã‚‹**',
              '- é–¢é€£ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆä¾‹: react, react-dom, @types/reactï¼‰ã¯åŒæ™‚ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰',
              '',
              '### 3. å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹é †',
              '',
              '#### **3-1. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰**',
              '',
              '```bash',
              'yarn upgrade [package-name]@latest',
              '# ã‚¿ã‚¤ãƒ—ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚å­˜åœ¨ã™ã‚‹å ´åˆ',
              'yarn upgrade @types/[package-name]@latest',
              '```',
              '',
              '#### **3-2. DBã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ï¼ˆzenstack/prismaé–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å ´åˆã®ã¿ï¼‰**',
              '',
              '```bash',
              'yarn db:generate',
              '```',
              '',
              '#### **3-3. ã€é‡è¦ã€‘ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼†Lintå®Ÿè¡Œï¼ˆå¿…é ˆï¼‰**',
              '',
              'ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ãŸå¾Œã¯ã€**å¿…ãš**ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š',
              '',
              '```bash',
              'yarn check:fix',
              '```',
              '',
              '#### **3-4. å‹•ä½œç¢ºèª**',
              '',
              'ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’**å¿…ãšã“ã®é †åºã§**å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š',
              '',
              '```bash',
              '# 1. Formatter & Linter ãƒã‚§ãƒƒã‚¯',
              'yarn check',
              '',
              '# 2. ãƒ“ãƒ«ãƒ‰',
              'yarn build',
              '',
              '# 3. ãƒ†ã‚¹ãƒˆ',
              'yarn test:run',
              '',
              '# 4. Storybookãƒ“ãƒ«ãƒ‰',
              'yarn build-storybook',
              '```',
              '',
              '#### **3-5. å•é¡ŒãŒãªã‘ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ**',
              '',
              '```bash',
              'git add .',
              'git commit -m "chore: upgrade [package-name] to [new-version]"',
              '```',
              '',
              '### 4. ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¾Œ',
              '',
              '```bash',
              '# PRã®ä½œæˆ',
              'git push origin HEAD',
              '```',
              '',
              '---',
              '',
              '## æ³¨æ„äº‹é …',
              '',
              '### âš ï¸ å¿…é ˆäº‹é …',
              '',
              '1. **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintã®å¾¹åº•**: ã©ã‚“ãªå°ã•ãªå¤‰æ›´ã§ã‚‚ã€å¤‰æ›´å¾Œã¯å¿…ãš `yarn check:fix` ã‚’å®Ÿè¡Œ',
              '2. **ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆã®ç¢ºèª**: ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª',
              '3. **1ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãšã¤**: è¤‡æ•°ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€åº¦ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãªã„ï¼ˆé–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯é™¤ãï¼‰',
              '',
              '### ğŸ’¡ å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®å¯¾å‡¦',
              '',
              '- å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ãã®æ™‚ç‚¹ã§ä½œæ¥­ã‚’åœæ­¢ã—åŸå› ã‚’èª¿æŸ»',
              '- ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã®å ´åˆã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å¤‰æ›´ç‚¹ã‚’ç¢ºèª',
              '- Breaking ChangesãŒã‚ã‚‹å ´åˆã¯ã€å¿…è¦ãªã‚³ãƒ¼ãƒ‰ä¿®æ­£ã‚’å®Ÿæ–½',
              '',
              '### ğŸ” ç‰¹ã«æ³¨æ„ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸',
              '',
              '- Next.js: React ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§ã‚’ç¢ºèª',
              '- React/React DOM: é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆ@types/react, @types/react-domï¼‰ã‚‚åŒæ™‚æ›´æ–°',
              '- Prisma/ZenStack: DB ã‚¹ã‚­ãƒ¼ãƒã®å†ç”ŸæˆãŒå¿…è¦',
              '- TypeScript: å‹å®šç¾©ã®äº’æ›æ€§ã‚’ç¢ºèª',
              '- Storybooké–¢é€£: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ãŒå¿…è¦ãªå ´åˆã‚ã‚Š',
              '',
              '---',
              '',
              '## å‚è€ƒãƒªãƒ³ã‚¯',
              '',
              '- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ README](https://github.com/WakuwakuP/my-template-nextjs/blob/master/README.md)',
              '- [Copilot Instructions](https://github.com/WakuwakuP/my-template-nextjs/blob/master/.github/copilot-instructions.md)',
              ''
            ].join('\n');

            const issueDate = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Tokyo' });

            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“¦ Weekly Package Upgrade (${issueDate})`,
              body: issueBody,
              labels: ['dependencies', 'maintenance', 'automated', 'copilot'],
            });

            console.log('Created issue #' + issue.data.number + ': ' + issue.data.html_url);
            console.log('Assigned to @copilot');
            return issue.data.number;

      - name: assignees issue to Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.ISSUE_ASSIGN_TO_COPILOT_PAT }} # NOTE: copilotã®èª²é‡‘ç¢ºèªã®ãŸã‚ã«PATã‚’åˆ©ç”¨
        run: |
          gh issue edit ${{ steps.create_issue.outputs.result }} --add-assignee @copilot --repo ${{ github.repository }}
